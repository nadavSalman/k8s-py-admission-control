






# Py Admission Control

## Overview
Admission webhook server. Follow best practices as outlined in the [Kubernetes documentation](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/).
The webhook handles the AdmissionReview request sent by the API servers, and sends back its decision as an AdmissionReview object in the same version it received.

## Modules
- **admission_webhook**: The main module that handles the admission review requests and applies the resource limits.
- **logging_config**: Configures logging for the admission webhook.
- **admission**: Hendler for AdmissionReview response .

## Mutation Example
To see the mutation applied by the admission controller, you can use the following command:

```yaml
  apiVersion: admissionregistration.k8s.io/v1
  kind: MutatingWebhookConfiguration
  metadata:
    name: resource.request.limiter
  webhooks:
    - name: py-admission-webhook.default.svc
      clientConfig:
        service:
          name: py-admission-webhook
          namespace: default
          path: "/mutating/resource-request-limiter"
        caBundle: CA_BUNDLE
      rules:
        - operations: ["CREATE"]
          apiGroups: [""]
          apiVersions: ["v1"]
          resources: ["pods"]
      admissionReviewVersions: ["v1"]
      sideEffects: None
```


```sh
 
❯ kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: trigger-mutation
  namespace: default
spec:
  containers:
  - name: nginx
    image: nginx
    resources:
      requests:
        cpu: "100m"
        memory: "100Mi"
EOF
Warning: Resource requests have been limited to 10m CPU and 10Mi memory.
pod/trigger-mutation created

 
❯ kubectl get pod trigger-mutation -n default -o yaml | yq '.spec.containers[].resources.requests'
{
  "cpu": "10m",
  "memory": "10Mi"
}

 
❯ 

```

## Admission Server Logs
Below is an example of the logs generated by the admission server:

```sh
❯ kubectl logs -l app=py-admission-webhook -n default -f
 * Debug mode: on
 * Running on all addresses (0.0.0.0)
 * Running on https://127.0.0.1:443
 * Running on https://10.104.140.101:443
2025-02-23 11:39:56,972 - werkzeug - INFO - Press CTRL+C to quit
2025-02-23 11:39:56,973 - werkzeug - INFO -  * Restarting with stat
2025-02-23 11:40:03,674 - admission_webhook.logging_config.logging_config - INFO - Loaded in-cluster Kubernetes configuration.
2025-02-23 11:40:03,776 - werkzeug - WARNING -  * Debugger is active!
2025-02-23 11:40:03,777 - werkzeug - INFO -  * Debugger PIN: 143-583-386
2025-02-23 11:41:41,590 - admission_webhook.logging_config.logging_config - INFO - Received admission review for UID: fb69a74d-a6cd-4434-b838-d18f120275a3, Namespace: default
2025-02-23 11:41:41,614 - admission_webhook.logging_config.logging_config - INFO - Namespace default is not excluded. Applying resource limits.
2025-02-23 11:41:41,614 - admission_webhook.logging_config.logging_config - INFO - Container 0 CPU request 100m exceeds limit. Setting to 10m.
2025-02-23 11:41:41,614 - admission_webhook.logging_config.logging_config - INFO - Container 0 Memory request 100Mi exceeds limit. Setting to 10Mi.
2025-02-23 11:41:41,614 - admission_webhook.logging_config.logging_config - INFO - Patch: [
    {
        "op": "add",
        "path": "/spec/containers/0/resources/requests/cpu",
        "value": "10m"
    },
    {
        "op": "add",
        "path": "/spec/containers/0/resources/requests/memory",
        "value": "10Mi"
    }
]
2025-02-23 11:41:41,615 - admission_webhook.logging_config.logging_config - INFO - AdmissionResponse created: {
    "apiVersion": "admission.k8s.io/v1",
    "kind": "AdmissionReview",
    "response": {
        "uid": "fb69a74d-a6cd-4434-b838-d18f120275a3",
        "allowed": true,
        "patch": "W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvY29udGFpbmVycy8wL3Jlc291cmNlcy9yZXF1ZXN0cy9jcHUiLCAidmFsdWUiOiAiMTBtIn0sIHsib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvY29udGFpbmVycy8wL3Jlc291cmNlcy9yZXF1ZXN0cy9tZW1vcnkiLCAidmFsdWUiOiAiMTBNaSJ9XQ==",
        "patchType": "JSONPatch",
        "warnings": [
            "Resource requests have been limited to 10m CPU and 10Mi memory."
        ]
    }
}
2025-02-23 11:41:41,616 - werkzeug - INFO - 10.104.64.21 - - [23/Feb/2025 11:41:41] "POST /mutating/resource-request-limiter?timeout=10s HTTP/1.1" 200 -
```









## Excluding a Namespace

### Method A:
To exclude a namespace from the admission control, you can label the namespace with `admission.devop/ignore=true` using the following command:

```sh
kubectl label namespace <namespace-name> admission.devop/ignore=true
```

Replace `<namespace-name>` with the name of the namespace you want to exclude.

### Method B:
Use the NamespaceValidator class. This class checks if a namespace matches any of the predefined patterns.

